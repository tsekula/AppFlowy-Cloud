# Caddyfile for AppFlowy-Cloud
# Converting from the nginx configuration

{
    # Global options
    admin off
    debug
}

# Metrics endpoint (corresponds to nginx stub_status)
:8080 {
    metrics
}

# Main server block
docs.skyoverhill.com {
    # Global settings
    encode gzip
    
    # Default body size limit (can be overridden in specific routes)
    request_body {
        max_size 10M
    }

    # GoTrue authentication service
    handle /gotrue/* {
        uri strip_prefix /gotrue
        
        # CORS for GoTrue
        @options {
            method OPTIONS
        }
        handle @options {
            header {
                Access-Control-Allow-Origin {http.request.header.Origin}
                Access-Control-Allow-Credentials "true"
                Access-Control-Allow-Headers "*"
                Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
                Content-Type "text/plain charset=UTF-8"
                Content-Length "0"
            }
            respond 204
        }
        
        reverse_proxy gotrue:9999
    }

    # WebSocket endpoint
    handle /ws {
        reverse_proxy appflowy_cloud:8000 {
            transport websocket {
                keepalive 86400s
            }
        }
    }

    # API endpoints
    handle /api/* {
        # CORS for API
        @options {
            method OPTIONS
        }
        handle @options {
            header {
                Access-Control-Allow-Origin {http.request.header.Origin}
                Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
                Access-Control-Allow-Headers "Content-Type, Authorization, Accept, Client-Version, Device-Id"
                Access-Control-Max-Age "3600"
            }
            respond 204
        }

        # Workspace publish endpoint
        @publish {
            path_regexp ^/api/workspace/([a-zA-Z0-9_-]+)/publish$
        }
        handle @publish {
            request_body {
                max_size 256M
            }
            reverse_proxy appflowy_cloud:8000
        }

        # Chat endpoint
        @chat {
            path /api/chat
        }
        handle @chat {
            reverse_proxy appflowy_cloud:8000 {
                timeout 600s
                flush_interval -1
            }
        }

        # Import endpoint
        @import {
            path /api/import
        }
        handle @import {
            request_body {
                max_size 2G
            }
            reverse_proxy appflowy_cloud:8000 {
                timeout 600s
            }
        }

        # Default API handling
        reverse_proxy appflowy_cloud:8000
    }

    # AppFlowy AI
    handle /ai/* {
        reverse_proxy ai:5001
    }

    # Minio Web UI
    handle /minio/* {
        uri strip_prefix /minio
        reverse_proxy minio:9001 {
            transport websocket
        }
    }

    # Minio API (for presigned URLs)
    handle /minio-api/* {
        uri strip_prefix /minio-api
        header_up Host {http.reverse_proxy.upstream.hostport}
        reverse_proxy minio:9000
    }

    # PgAdmin
    handle /pgadmin/* {
        header_up X-Script-Name /pgadmin
        header_up X-Scheme {scheme}
        reverse_proxy pgadmin:80
    }

    # Portainer
    handle /portainer/* {
        uri strip_prefix /portainer
        reverse_proxy portainer:9000
    }

    # Admin Frontend
    handle /console* {
        header_up X-Scheme {scheme}
        reverse_proxy admin_frontend:3000
    }

    # Default handler for AppFlowy Web
    handle {
        header_up X-Scheme {scheme}
        reverse_proxy appflowy_web:80
    }
}

# HTTP to HTTPS redirect
http://docs.skyoverhill.com {
    redir https://{host}{uri} permanent
}
